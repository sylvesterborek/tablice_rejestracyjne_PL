<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gra: Tablice rejestracyjne ‚Äì powiaty Polski</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 12px 14px; border-bottom: 1px solid #ddd; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 16px; margin: 0; font-weight: 650; }
    .pill { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 13px; }
    .btn { padding: 8px 10px; border: 1px solid #bbb; border-radius: 10px; background: #fff; cursor: pointer; font-size: 13px; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .55; cursor: not-allowed; }
    .wrap { display: grid; grid-template-columns: 360px 1fr; height: calc(100vh - 58px); }
    @media (max-width: 900px) { .wrap { grid-template-columns: 1fr; grid-template-rows: 360px 1fr; } }
    #panel { padding: 12px 14px; border-right: 1px solid #ddd; overflow: auto; }
    @media (max-width: 900px) { #panel { border-right: none; border-bottom: 1px solid #ddd; } }

    #map { height: 100%; }
    .q { font-size: 14px; line-height: 1.35; margin: 0 0 10px; }
    .muted { color: #555; font-size: 13px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="text"] { padding: 10px; border: 1px solid #bbb; border-radius: 10px; font-size: 14px; width: 140px; text-transform: uppercase; }
    .ok { color: #0b6; font-weight: 650; }
    .bad { color: #c22; font-weight: 650; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 10px; margin-top: 10px; background: #fafafa; }
    .small { font-size: 12px; color: #666; }
    code { background: #f0f0f0; padding: 1px 5px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Gra: Tablice rejestracyjne ‚Äì powiaty Polski</h1>
    <span class="pill">Wynik: <b id="score">0</b></span>
    <span class="pill">Seria: <b id="streak">0</b></span>
    <span class="pill">Za≈Çadowane powiaty: <b id="nPow">0</b></span>
    <span class="pill">Powiaty z kodem: <b id="nPlayable">0</b></span>
    <button class="btn" id="btnStart">Start / Nastƒôpny</button>
    <button class="btn" id="btnHint" disabled>Poka≈º podpowied≈∫</button>
    <button class="btn" id="btnToggleTiles" disabled>Mapa t≈Ça: ON</button>
    <button class="btn" id="btnExport" disabled>Eksportuj JSON (powiaty+tablice)</button>
    <button class="btn" id="btnReset">Reset</button>
  </header>

  <div class="wrap">
    <div id="panel">
      <p class="q" id="question">≈Åadujƒô dane‚Ä¶</p>

      <div class="row">
        <input type="text" id="answer" placeholder="np. SK" disabled />
        <button class="btn" id="btnCheck" disabled>Sprawd≈∫</button>
      </div>

      <div class="box" id="feedback" style="display:none;"></div>

      <div class="box">
        <div class="muted" style="margin-bottom:6px;"><b>SkƒÖd sƒÖ dane?</b></div>
        <div class="small">
          Granice powiat√≥w: <code>ppatrzyk/polska-geojson</code> (wariant ‚Äûmin‚Äù).<br/>
          Kody tablic: pobierane z polskiej Wikipedii przez API (<code>origin=*</code>).<br/><br/>
          Je≈õli wrzucasz to na GitHub Pages: pamiƒôtaj, ≈ºe pliki muszƒÖ byƒá serwowane przez HTTP/HTTPS (nie z <code>file://</code>).
        </div>
      </div>

      <div class="box">
        <div class="muted" style="margin-bottom:6px;"><b>Ustawienia / wskaz√≥wki</b></div>
        <div class="small">
          ‚Ä¢ Wpisuj wyr√≥≈ºnik (1‚Äì3 znaki), np. <code>SK</code>, <code>DW</code>, <code>SBE</code>.<br/>
          ‚Ä¢ Dla niekt√≥rych obszar√≥w mo≈ºe istnieƒá kilka wyr√≥≈ºnik√≥w ‚Äî wtedy akceptujƒô ka≈ºdy poprawny.<br/>
          ‚Ä¢ Je≈õli jaki≈õ powiat nie ma dopasowanego kodu (r√≥≈ºnice w nazwach), jest pomijany w losowaniu.
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>

<script>
  // ====== Konfiguracja ≈∫r√≥de≈Ç danych ======
  // Powiaty (lekki plik ~377 kB)
  const POWIATY_GEOJSON_URL = "https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/powiaty/powiaty-min.geojson";

  // Wikipedia (PL) ‚Äì strona z wyr√≥≈ºnikami (API ma CORS przez origin=*)
  const WIKI_API_URL = "https://pl.wikipedia.org/w/api.php?action=parse&page=Tablice_rejestracyjne_w_Polsce&prop=text&formatversion=2&format=json&origin=*";

  // ====== Pomocnicze ======
  function stripDiacritics(s) {
    return (s || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeAreaName(s) {
    if (!s) return "";
    let x = s.toString().trim();

    // usu≈Ñ przypisy w nawiasach, "miasto na prawach powiatu" itd.
    x = x.replace(/\(.*?\)/g, " ");
    x = x.replace(/\s+/g, " ").trim();

    // popularne prefiksy
    x = x
      .replace(/^powiat\s+/i, "")
      .replace(/^m\.\s*/i, "")
      .replace(/^miasto\s+/i, "")
      .replace(/^miasto\s+na\s+prawach\s+powiatu\s+/i, "")
      .replace(/^powiat\s+m\.\s*/i, "");

    x = x.replace(/\s+/g, " ").trim();
    x = stripDiacritics(x).toLowerCase();
    return x;
  }

  function extractNameFromFeatureProps(props) {
    if (!props) return "";
    const keys = Object.keys(props);

    // najczƒôstsze klucze z r√≥≈ºnych geojson√≥w
    const candidates = [
      "name", "NAME", "nazwa", "NAZWA",
      "powiat", "Powiat",
      "JPT_NAZWA_", "JPT_NAZWA", "JPT_NAZWA1",
      "jpt_nazwa_", "jpt_nazwa"
    ];

    for (const k of candidates) {
      if (k in props && props[k]) return props[k];
    }

    // fallback: szukaj klucza zawierajƒÖcego "nazwa" albo "powiat"
    for (const k of keys) {
      const lk = k.toLowerCase();
      if ((lk.includes("nazwa") || lk.includes("powiat")) && props[k]) return props[k];
    }

    // ostatnia deska ratunku
    return props[keys[0]] || "";
  }

  function codesFromCellText(t) {
    // Zwraca listƒô kod√≥w np. "DW, DX" -> ["DW","DX"]
    // Akceptujemy litery/cyfry 1‚Äì3 znaki (w PL realnie 1‚Äì3)
    const matches = (t || "").toUpperCase().match(/[A-Z0-9]{1,3}/g);
    if (!matches) return [];
    // odfiltruj ≈õmieci typu "PL", "EU" je≈õli by siƒô trafi≈Ço
    return matches.filter(x => x.length >= 1 && x.length <= 3);
  }

  // ====== Stan gry ======
  let map, tilesLayer, geoLayer;
  let powiatyGeojson = null;

  // mapping: normalized powiat name -> array of codes
  let codesByArea = new Map();

  // playable list (features with code match)
  let playable = [];

  let current = null;
  let score = 0;
  let streak = 0;
  let showHint = false;
  let tilesOn = true;

  // ====== UI ======
  const el = (id) => document.getElementById(id);
  const ui = {
    score: el("score"),
    streak: el("streak"),
    nPow: el("nPow"),
    nPlayable: el("nPlayable"),
    question: el("question"),
    answer: el("answer"),
    feedback: el("feedback"),
    btnStart: el("btnStart"),
    btnHint: el("btnHint"),
    btnToggleTiles: el("btnToggleTiles"),
    btnExport: el("btnExport"),
    btnReset: el("btnReset"),
    btnCheck: el("btnCheck"),
  };

  function setFeedback(html, ok=null) {
    ui.feedback.style.display = "block";
    ui.feedback.innerHTML = html;
    if (ok === true) ui.feedback.className = "box ok";
    else if (ok === false) ui.feedback.className = "box bad";
    else ui.feedback.className = "box";
  }

  function clearFeedback() {
    ui.feedback.style.display = "none";
    ui.feedback.innerHTML = "";
    ui.feedback.className = "box";
  }

  function setQuestion(text) {
    ui.question.textContent = text;
  }

  function updateStats() {
    ui.score.textContent = score;
    ui.streak.textContent = streak;
    ui.nPow.textContent = powiatyGeojson?.features?.length ?? 0;
    ui.nPlayable.textContent = playable.length;
  }

  function enableGameControls(enabled) {
    ui.answer.disabled = !enabled;
    ui.btnCheck.disabled = !enabled;
    ui.btnHint.disabled = !enabled;
    ui.btnToggleTiles.disabled = !enabled;
    ui.btnExport.disabled = !enabled;
  }

  // ====== Map ======
  function initMap() {
    map = L.map("map", { zoomControl: true });
    tilesLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    });

    tilesLayer.addTo(map);
    map.setView([52.1, 19.4], 6);
  }

  function styleDefault() {
    return { weight: 1, opacity: 0.9, fillOpacity: 0.25 };
  }
  function styleSelected() {
    return { weight: 3, opacity: 1.0, fillOpacity: 0.55 };
  }

  function renderGeojson() {
    if (geoLayer) geoLayer.remove();
    geoLayer = L.geoJSON(powiatyGeojson, {
      style: styleDefault,
      onEachFeature: (feature, layer) => {
        layer.on("click", () => {
          // klik = poka≈º kod je≈õli jest
          const nm = extractNameFromFeatureProps(feature.properties);
          const nkey = normalizeAreaName(nm);
          const codes = codesByArea.get(nkey) || [];
          const codeTxt = codes.length ? codes.join(", ") : "brak dopasowania";
          layer.bindPopup(`<b>${nm}</b><br/>Wyr√≥≈ºnik: <b>${codeTxt}</b>`).openPopup();
        });
      }
    }).addTo(map);
  }

  function setTiles(on) {
    tilesOn = on;
    if (tilesOn) {
      if (!map.hasLayer(tilesLayer)) tilesLayer.addTo(map);
      ui.btnToggleTiles.textContent = "Mapa t≈Ça: ON";
    } else {
      if (map.hasLayer(tilesLayer)) map.removeLayer(tilesLayer);
      ui.btnToggleTiles.textContent = "Mapa t≈Ça: OFF";
    }
  }

  // ====== Dane: Wikipedia -> mapowanie ======
  async function loadWikiCodes() {
    const res = await fetch(WIKI_API_URL);
    if (!res.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá danych z Wikipedii.");
    const data = await res.json();
    const html = data?.parse?.text;
    if (!html) throw new Error("Wikipedia API zwr√≥ci≈Ço nieoczekiwany format.");

    const doc = new DOMParser().parseFromString(html, "text/html");

    // Znajd≈∫ tabelƒô, kt√≥ra ma w nag≈Ç√≥wku "Wyr√≥≈ºnik" oraz "Powiat" (lub "Miasto")
    const tables = Array.from(doc.querySelectorAll("table"));
    let target = null;

    for (const t of tables) {
      const headerText = t.querySelector("tr")?.innerText?.toLowerCase() || "";
      if (headerText.includes("wyr√≥≈ºnik") && (headerText.includes("powiat") || headerText.includes("miasto"))) {
        target = t;
        break;
      }
    }

    // Fallback: we≈∫ pierwszƒÖ tabelƒô z "wyr√≥≈ºnik"
    if (!target) {
      target = tables.find(t => (t.innerText || "").toLowerCase().includes("wyr√≥≈ºnik")) || null;
    }
    if (!target) throw new Error("Nie znalaz≈Çem tabeli z wyr√≥≈ºnikami na Wikipedii.");

    const rows = Array.from(target.querySelectorAll("tr")).slice(1);

    const tmp = new Map(); // normalized name -> codes[]
    for (const tr of rows) {
      const tds = Array.from(tr.querySelectorAll("td"));
      if (tds.length < 2) continue;
      const codeCell = (tds[0].innerText || "").trim();
      const areaCell = (tds[1].innerText || "").trim();
      if (!codeCell || !areaCell) continue;

      const codes = codesFromCellText(codeCell);
      if (!codes.length) continue;

      const key = normalizeAreaName(areaCell);
      if (!key) continue;

      if (!tmp.has(key)) tmp.set(key, []);
      const arr = tmp.get(key);

      for (const c of codes) {
        if (!arr.includes(c)) arr.push(c);
      }
    }

    codesByArea = tmp;
  }

  // ====== Dane: GeoJSON powiat√≥w ======
  async function loadPowiatyGeojson() {
    const res = await fetch(POWIATY_GEOJSON_URL);
    if (!res.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá granic powiat√≥w (GeoJSON).");
    powiatyGeojson = await res.json();
    if (!powiatyGeojson?.features?.length) throw new Error("GeoJSON nie zawiera obiekt√≥w.");
  }

  function buildPlayableList() {
    playable = [];
    for (const f of powiatyGeojson.features) {
      const nm = extractNameFromFeatureProps(f.properties);
      const key = normalizeAreaName(nm);
      const codes = codesByArea.get(key);
      if (codes && codes.length) playable.push(f);
    }
  }

  // ====== Gra ======
  function clearSelection() {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => layer.setStyle(styleDefault()));
  }

  function selectFeature(feature) {
    current = feature;
    showHint = false;
    ui.btnHint.textContent = "Poka≈º podpowied≈∫";
    ui.answer.value = "";
    ui.answer.focus();
    clearFeedback();

    clearSelection();
    let selectedLayer = null;
    geoLayer.eachLayer(layer => {
      // por√≥wnanie po referencji feature
      if (layer.feature === feature) {
        selectedLayer = layer;
        layer.setStyle(styleSelected());
        layer.bringToFront();
      }
    });

    // dopasuj widok
    if (selectedLayer) {
      const b = selectedLayer.getBounds();
      map.fitBounds(b.pad(0.25));
    }

    const nm = extractNameFromFeatureProps(feature.properties);
    setQuestion("Jaki jest wyr√≥≈ºnik tablic rejestracyjnych dla zaznaczonego powiatu?");
    setFeedback(`<div class="muted">Wpisz kod (1‚Äì3 znaki) i kliknij <b>Sprawd≈∫</b>.</div>`, null);

    // je≈õli hint w≈ÇƒÖczony, poka≈º nazwƒô
    if (showHint) {
      setFeedback(`<div><b>Powiat:</b> ${nm}</div>`, null);
    }
  }

  function pickRandom() {
    if (!playable.length) return null;
    const idx = Math.floor(Math.random() * playable.length);
    return playable[idx];
  }

  function checkAnswer() {
    if (!current) return;
    const user = (ui.answer.value || "").trim().toUpperCase();
    if (!user) return;

    const nm = extractNameFromFeatureProps(current.properties);
    const key = normalizeAreaName(nm);
    const codes = codesByArea.get(key) || [];

    const ok = codes.includes(user);
    if (ok) {
      score += 1;
      streak += 1;
      setFeedback(`<div class="ok">‚úÖ Dobrze!</div>
        <div><b>${nm}</b> ‚Üí poprawne: <b>${codes.join(", ")}</b></div>`, true);
    } else {
      streak = 0;
      setFeedback(`<div class="bad">‚ùå Nie.</div>
        <div><b>${nm}</b> ‚Üí poprawne: <b>${codes.join(", ")}</b></div>
        <div class="small">Wpisa≈Çe≈õ: <b>${user}</b></div>`, false);
    }
    updateStats();
  }

  function toggleHint() {
    if (!current) return;
    showHint = !showHint;
    ui.btnHint.textContent = showHint ? "Ukryj podpowied≈∫" : "Poka≈º podpowied≈∫";
    const nm = extractNameFromFeatureProps(current.properties);
    const key = normalizeAreaName(nm);
    const codes = codesByArea.get(key) || [];

    if (showHint) {
      setFeedback(`<div><b>Powiat:</b> ${nm}</div>
      <div class="small">Podpowied≈∫ nie psuje punkt√≥w üòâ</div>`, null);
    } else {
      setFeedback(`<div class="muted">Wpisz kod (1‚Äì3 znaki) i kliknij <b>Sprawd≈∫</b>.</div>`, null);
    }
  }

  function resetGame() {
    score = 0;
    streak = 0;
    current = null;
    ui.answer.value = "";
    clearFeedback();
    setQuestion("Kliknij ‚ÄûStart / Nastƒôpny‚Äù, ≈ºeby rozpoczƒÖƒá.");
    clearSelection();
    map.setView([52.1, 19.4], 6);
    updateStats();
  }

  // ====== Eksport: po≈ÇƒÖcz GeoJSON + kody ======
  function exportMergedJson() {
    if (!powiatyGeojson || !powiatyGeojson.features?.length) return;

    const merged = JSON.parse(JSON.stringify(powiatyGeojson));
    for (const f of merged.features) {
      const nm = extractNameFromFeatureProps(f.properties);
      const key = normalizeAreaName(nm);
      const codes = codesByArea.get(key) || [];
      f.properties = f.properties || {};
      f.properties.plate_codes = codes; // tablica, bo czasem jest kilka
      f.properties.plate_code = codes[0] || null; // wygodny skr√≥t
    }

    const blob = new Blob([JSON.stringify(merged)], { type: "application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "powiaty_tablice_merged.geojson";
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  // ====== Start: ≈Çaduj dane ======
  async function boot() {
    initMap();
    setQuestion("≈Åadujƒô granice powiat√≥w i wyr√≥≈ºniki tablic‚Ä¶");

    try {
      // r√≥wnolegle
      await Promise.all([loadPowiatyGeojson(), loadWikiCodes()]);
      renderGeojson();
      buildPlayableList();
      updateStats();

      enableGameControls(true);
      setQuestion("Gotowe. Kliknij ‚ÄûStart / Nastƒôpny‚Äù, ≈ºeby wylosowaƒá powiat.");
      clearFeedback();

      ui.btnStart.addEventListener("click", () => {
        const f = pickRandom();
        if (!f) return;
        selectFeature(f);
      });

      ui.btnCheck.addEventListener("click", checkAnswer);
      ui.answer.addEventListener("keydown", (e) => {
        if (e.key === "Enter") checkAnswer();
      });

      ui.btnHint.addEventListener("click", toggleHint);

      ui.btnToggleTiles.addEventListener("click", () => setTiles(!tilesOn));
      ui.btnExport.addEventListener("click", exportMergedJson);

      ui.btnReset.addEventListener("click", resetGame);

      // start z podk≈Çadem w≈ÇƒÖczonym
      setTiles(true);
      resetGame();

    } catch (err) {
      console.error(err);
      setQuestion("B≈ÇƒÖd ≈Çadowania danych.");
      setFeedback(`<div class="bad"><b>Nie uda≈Ço siƒô uruchomiƒá gry.</b></div>
        <div class="small">${(err && err.message) ? err.message : err}</div>
        <div class="small" style="margin-top:8px;">
          Tip: uruchom stronƒô przez HTTP/HTTPS (np. GitHub Pages) ‚Äì nie z <code>file://</code>.
        </div>`, false);
      enableGameControls(false);
    }
  }

  boot();
</script>
</body>
</html>
