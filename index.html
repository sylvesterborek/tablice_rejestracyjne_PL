<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gra: Tablice rejestracyjne ‚Üí kliknij powiat</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #0b0f19;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --ok: #10b981;
      --bad: #ef4444;
      --accent: #60a5fa;
      --border: rgba(255,255,255,0.08);
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; grid-template-rows: 380px 1fr; } }

    .sidebar {
      padding: 16px;
      border-right: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      overflow: auto;
    }
    @media (max-width: 900px) { .sidebar { border-right: none; border-bottom: 1px solid var(--border); } }

    h1 { font-size: 18px; margin: 0 0 8px; }
    .sub { color: var(--muted); font-size: 13px; margin-bottom: 14px; line-height: 1.35; }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      margin-bottom: 12px;
    }

    .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .target {
      font-size: 26px;
      font-weight: 900;
      letter-spacing: 1px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(96,165,250,0.12);
      text-align: center;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 650;
      cursor: pointer;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
      flex: 1 1 auto;
    }
    button:hover { background: rgba(255,255,255,0.10); }
    button:active { transform: translateY(1px); }
    button.primary { background: rgba(96,165,250,0.18); border-color: rgba(96,165,250,0.35); }
    button.danger  { background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.30); }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .stat {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
    }
    .stat .k { font-size: 12px; color: var(--muted); }
    .stat .v { font-size: 20px; font-weight: 850; margin-top: 2px; }

    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      min-height: 44px;
      line-height: 1.25;
      font-size: 14px;
    }
    .msg.ok { border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.10); }
    .msg.bad { border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.10); }

    .opt {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      font-size: 13px;
      color: var(--muted);
    }
    .opt input { transform: scale(1.05); }

    #map { width: 100%; height: 100%; background: #e5e7eb; }

    .footer {
      font-size: 12px;
      color: var(--muted);
      margin-top: 14px;
      line-height: 1.35;
    }

    code.inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: rgba(255,255,255,0.08);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <h1>Gra: tablice rejestracyjne ‚Üí kliknij powiat</h1>
      <div class="sub">
        Dostajesz <b>wyr√≥≈ºnik</b> (np. <code class="inline">SK</code>, <code class="inline">WA</code>), a Twoim zadaniem jest kliknƒÖƒá w≈Ça≈õciwy powiat/miasto na mapie.
        W trybie ‚ÄûPoznaj mapƒô‚Äù mo≈ºesz w≈ÇƒÖczyƒá tooltipy z nazwami.
      </div>

      <div class="card">
        <div class="label">Kliknij obszar dla wyr√≥≈ºnika:</div>
        <div class="target" id="targetCode">≈Åadowanie‚Ä¶</div>

        <div class="row">
          <button class="primary" id="btnNext" disabled>Nastƒôpny</button>
          <button class="danger" id="btnRestart" disabled>Restart</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k">Punkty</div>
            <div class="v" id="score">0</div>
          </div>
          <div class="stat">
            <div class="k">Postƒôp</div>
            <div class="v"><span id="done">0</span>/<span id="total">0</span></div>
          </div>
        </div>

        <div class="msg" id="message"></div>

        <div class="opt">
          <label>
            <input type="checkbox" id="learnMode" />
            Poznaj mapƒô (tooltip z nazwƒÖ)
          </label>
        </div>

        <div class="opt">
          <label>
            <input type="checkbox" id="showCorrect" checked />
            Poka≈º poprawny obszar po b≈Çƒôdzie
          </label>
        </div>

        <div class="opt">
          <label>
            <input type="checkbox" id="shuffleEachRun" checked />
            Losuj kolejno≈õƒá (ka≈ºdy restart)
          </label>
        </div>

        <div class="opt">
          <label>
            <input type="checkbox" id="tilesOn" checked />
            Poka≈º mapƒô t≈Ça (OSM)
          </label>
        </div>
      </div>

      <div class="footer">
        Wskaz√≥wka: na GitHub Pages plik powinien nazywaƒá siƒô <code class="inline">index.html</code>.
      </div>
    </aside>

    <main id="map"></main>
  </div>

<script>
(async function () {
  // ====== ≈πR√ìD≈ÅA DANYCH ======
  // GeoJSON powiat√≥w (zewnƒôtrzny, lekki). Je≈õli wolisz lokalnie: wrzuƒá plik do repo i ustaw np. "powiaty-min.geojson".
  const POWIATY_GEOJSON_URL = "https://raw.githubusercontent.com/ppatrzyk/polska-geojson/master/powiaty/powiaty-min.geojson";

  // Wikipedia (PL) ‚Äì tabela z wyr√≥≈ºnikami (API z CORS przez origin=*)
  const WIKI_API_URL = "https://pl.wikipedia.org/w/api.php?action=parse&page=Tablice_rejestracyjne_w_Polsce&prop=text&formatversion=2&format=json&origin=*";

  // ====== STYLE ======
  const baseStyle = {
    color: "rgba(0,0,0,0.80)",
    weight: 1.0,
    opacity: 0.9,
    fillColor: "#60a5fa",
    fillOpacity: 0.35
  };

  const hoverStyle = {
    weight: 2.4,
    opacity: 1.0,
    fillOpacity: 0.65
  };

  const correctStyle = {
    color: "rgba(0,0,0,0.95)",
    weight: 3.0,
    fillColor: "#10b981",
    fillOpacity: 0.75
  };

  const wrongStyle = {
    color: "rgba(0,0,0,0.95)",
    weight: 3.0,
    fillColor: "#ef4444",
    fillOpacity: 0.75
  };

  const revealCorrectStyle = {
    color: "rgba(0,0,0,0.95)",
    weight: 3.0,
    fillColor: "#10b981",
    fillOpacity: 0.25
  };

  // ====== UI ======
  const elTarget = document.getElementById("targetCode");
  const elScore = document.getElementById("score");
  const elDone  = document.getElementById("done");
  const elTotal = document.getElementById("total");
  const elMsg   = document.getElementById("message");

  const btnNext = document.getElementById("btnNext");
  const btnRestart = document.getElementById("btnRestart");

  const chkLearnMode = document.getElementById("learnMode");
  const chkShowCorrect = document.getElementById("showCorrect");
  const chkShuffleEachRun = document.getElementById("shuffleEachRun");
  const chkTilesOn = document.getElementById("tilesOn");

  function setMessage(text, type) {
    elMsg.classList.remove("ok", "bad");
    if (type === "ok") elMsg.classList.add("ok");
    if (type === "bad") elMsg.classList.add("bad");
    elMsg.textContent = text || "";
  }

  // ====== MAPA ======
  const map = L.map("map", { zoomControl: true });

  let tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  chkTilesOn.addEventListener("change", () => {
    if (chkTilesOn.checked) {
      if (!map.hasLayer(tiles)) tiles.addTo(map);
    } else {
      if (map.hasLayer(tiles)) map.removeLayer(tiles);
    }
  });

  // ====== NORMALIZACJA NAZW ======
  function stripDiacritics(s) {
    return (s || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeAreaName(s) {
    if (!s) return "";
    let x = s.toString().trim();

    // usu≈Ñ przypisy, dopiski, nawiasy
    x = x.replace(/\(.*?\)/g, " ");
    x = x.replace(/\s+/g, " ").trim();

    // popularne prefiksy
    x = x
      .replace(/^powiat\s+/i, "")
      .replace(/^m\.\s*/i, "")
      .replace(/^miasto\s+/i, "")
      .replace(/^miasto\s+na\s+prawach\s+powiatu\s+/i, "")
      .replace(/^powiat\s+m\.\s*/i, "");

    x = x.replace(/\s+/g, " ").trim();
    x = stripDiacritics(x).toLowerCase();
    return x;
  }

  function extractNameFromFeatureProps(props) {
    if (!props) return "";
    const candidates = [
      "name", "NAME", "nazwa", "NAZWA",
      "powiat", "Powiat",
      "JPT_NAZWA_", "JPT_NAZWA", "JPT_NAZWA1",
      "jpt_nazwa_", "jpt_nazwa"
    ];
    for (const k of candidates) {
      if (props[k]) return String(props[k]).trim();
    }
    // fallback: szukaj pierwszego sensownego stringa
    for (const k of Object.keys(props)) {
      const v = props[k];
      if (typeof v === "string" && v.trim().length >= 3) return v.trim();
    }
    return "";
  }

  // ====== WIKIPEDIA: WYCIƒÑGNIƒòCIE KOD√ìW ======
  function codesFromCellText(text) {
    // np. "SK", "SBI", "WA, WB" itd.
    // bierzemy tylko 1‚Äì3 litery (bez cyfr / my≈õlnik√≥w)
    const raw = (text || "").toUpperCase();
    const matches = raw.match(/[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]{1,3}/g) || [];
    // w praktyce tablice to A‚ÄìZ (bez polskich znak√≥w), wiƒôc filtrujemy:
    const cleaned = matches
      .map(x => x.replace(/[^A-Z]/g, ""))
      .filter(x => x.length >= 1 && x.length <= 3);
    // usu≈Ñ duplikaty
    return Array.from(new Set(cleaned));
  }

  async function loadWikiCodes() {
    const res = await fetch(WIKI_API_URL);
    if (!res.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá danych z Wikipedii.");
    const data = await res.json();
    const html = data?.parse?.text;
    if (!html) throw new Error("Wikipedia API zwr√≥ci≈Ço nieoczekiwany format.");

    const doc = new DOMParser().parseFromString(html, "text/html");

    // tabela z nag≈Ç√≥wkiem zawierajƒÖcym "Wyr√≥≈ºnik" oraz "Powiat"/"Miasto"
    const tables = Array.from(doc.querySelectorAll("table"));
    let target = null;

    for (const t of tables) {
      const headerText = t.querySelector("tr")?.innerText?.toLowerCase() || "";
      if (headerText.includes("wyr√≥≈ºnik") && (headerText.includes("powiat") || headerText.includes("miasto"))) {
        target = t;
        break;
      }
    }
    if (!target) {
      target = tables.find(t => (t.innerText || "").toLowerCase().includes("wyr√≥≈ºnik")) || null;
    }
    if (!target) throw new Error("Nie znalaz≈Çem tabeli z wyr√≥≈ºnikami na Wikipedii.");

    const rows = Array.from(target.querySelectorAll("tr")).slice(1);

    const tmp = new Map(); // normalized name -> codes[]
    for (const tr of rows) {
      const tds = Array.from(tr.querySelectorAll("td"));
      if (tds.length < 2) continue;

      const codeCell = (tds[0].innerText || "").trim();
      const areaCell = (tds[1].innerText || "").trim();
      if (!codeCell || !areaCell) continue;

      const codes = codesFromCellText(codeCell);
      if (!codes.length) continue;

      const key = normalizeAreaName(areaCell);
      if (!key) continue;

      if (!tmp.has(key)) tmp.set(key, []);
      const arr = tmp.get(key);
      for (const c of codes) {
        if (!arr.includes(c)) arr.push(c);
      }
    }

    return tmp;
  }

  // ====== GEOJSON POWIAT√ìW ======
  async function loadPowiatyGeojson() {
    const res = await fetch(POWIATY_GEOJSON_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá granic powiat√≥w (GeoJSON).");
    const geo = await res.json();
    if (!geo || geo.type !== "FeatureCollection" || !Array.isArray(geo.features) || !geo.features.length) {
      throw new Error("GeoJSON ma z≈Çy format lub nie zawiera obiekt√≥w.");
    }
    return geo;
  }

  // ====== BUDOWANIE PYTA≈É ======
  // quizItem: { code, key, name }
  function buildQuizItems(powiatyGeo, codesByArea) {
    const items = [];
    for (const f of powiatyGeo.features) {
      const nm = extractNameFromFeatureProps(f.properties);
      const key = normalizeAreaName(nm);
      const codes = codesByArea.get(key);
      if (!codes || !codes.length) continue;
      for (const code of codes) {
        items.push({ code, key, name: nm });
      }
    }
    // usu≈Ñ duplikaty (czasem ta sama para mo≈ºe siƒô zdublowaƒá)
    const seen = new Set();
    const unique = [];
    for (const it of items) {
      const k = it.code + "|" + it.key;
      if (seen.has(k)) continue;
      seen.add(k);
      unique.push(it);
    }
    return unique;
  }

  // ====== TOOLTIP ======
  function applyTooltip(layer, name) {
    layer.unbindTooltip();
    if (chkLearnMode.checked) {
      layer.bindTooltip(name || "", { sticky: true });
    }
  }

  // ====== STAN GRY ======
  const state = {
    items: [],
    idx: 0,
    score: 0,
    done: 0,
    locked: false,
    current: null,      // current quizItem
    lastClicked: null,  // layer
    lastCorrect: null,  // layer
  };

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function resetAllStyles() {
    geoLayer.eachLayer(l => geoLayer.resetStyle(l));
  }

  function resetAfterRound() {
    if (state.lastClicked) geoLayer.resetStyle(state.lastClicked);
    if (state.lastCorrect && state.lastCorrect !== state.lastClicked) geoLayer.resetStyle(state.lastCorrect);
    state.lastClicked = null;
    state.lastCorrect = null;
  }

  function setCounters() {
    elScore.textContent = String(state.score);
    elDone.textContent = String(state.done);
  }

  function nextQuestion() {
    resetAfterRound();

    if (chkLearnMode.checked) {
      elTarget.textContent = "TRYB NAUKI";
      setMessage("Tooltipy sƒÖ w≈ÇƒÖczone. Klikniƒôcia nie punktujƒÖ. Odznacz tryb, aby graƒá.", "");
      btnNext.disabled = true;
      state.locked = false;
      return;
    }

    if (state.idx >= state.items.length) {
      elTarget.textContent = "KONIEC üéâ";
      setMessage(`Koniec! Wynik: ${state.score}/${state.items.length}.`, "ok");
      btnNext.disabled = true;
      state.locked = true;
      return;
    }

    state.current = state.items[state.idx];
    elTarget.textContent = state.current.code;
    setMessage("Kliknij w≈Ça≈õciwy powiat/miasto na mapie.", "");
    btnNext.disabled = true;
    state.locked = false;
  }

  function handleClick(clickedKey, clickedName, layer) {
    state.locked = true;

    const target = state.current;
    const isCorrect = clickedKey === target.key;

    layer.setStyle(isCorrect ? correctStyle : wrongStyle);
    layer.bringToFront();
    state.lastClicked = layer;

    state.done += 1;

    if (isCorrect) {
      state.score += 1;
      setMessage("‚úÖ Dobrze!", "ok");
    } else {
      setMessage(`‚ùå ≈πle. Poprawnie: ${target.name}`, "bad");
      if (chkShowCorrect.checked) {
        const correctLayer = layerByKey.get(target.key);
        if (correctLayer) {
          correctLayer.setStyle(revealCorrectStyle);
          correctLayer.bringToFront();
          state.lastCorrect = correctLayer;
        }
      }
    }

    setCounters();
    btnNext.disabled = false;
    state.idx += 1;
  }

  btnNext.addEventListener("click", () => nextQuestion());
  btnRestart.addEventListener("click", () => startGame());

  chkLearnMode.addEventListener("change", () => {
    state.locked = false;
    btnNext.disabled = true;
    resetAfterRound();
    resetAllStyles();

    // prze≈ÇƒÖcz tooltipy
    geoLayer.eachLayer(layer => {
      const nm = layer?.feature?._nm || "";
      applyTooltip(layer, nm);
    });

    if (chkLearnMode.checked) {
      elTarget.textContent = "TRYB NAUKI";
      setMessage("Tooltipy sƒÖ w≈ÇƒÖczone. Klikniƒôcia nie punktujƒÖ. Odznacz tryb, aby graƒá.", "");
    } else {
      setMessage("Tryb gry: tooltipy wy≈ÇƒÖczone.", "");
      nextQuestion();
    }
  });

  // ====== Wczytanie danych + inicjalizacja mapy ======
  let powiatyGeo = null;
  let codesByArea = null;

  try {
    setMessage("≈Åadowanie granic powiat√≥w‚Ä¶", "");
    powiatyGeo = await loadPowiatyGeojson();

    setMessage("≈Åadowanie wyr√≥≈ºnik√≥w tablic‚Ä¶", "");
    codesByArea = await loadWikiCodes();
  } catch (e) {
    console.error(e);
    elTarget.textContent = "B≈ÅƒÑD";
    setMessage(String(e?.message || e), "bad");
    return;
  }

  const quizItems = buildQuizItems(powiatyGeo, codesByArea);
  if (!quizItems.length) {
    elTarget.textContent = "B≈ÅƒÑD";
    setMessage("Nie uda≈Ço siƒô dopasowaƒá wyr√≥≈ºnik√≥w do powiat√≥w. (Zmieni≈Ç siƒô format danych).", "bad");
    return;
  }

  elTotal.textContent = String(quizItems.length);

  const layerByKey = new Map(); // normalized key -> layer
  let geoLayer = L.geoJSON(powiatyGeo, {
    style: () => ({ ...baseStyle }),
    onEachFeature: (feature, layer) => {
      const name = extractNameFromFeatureProps(feature.properties);
      const key = normalizeAreaName(name);

      // zapamiƒôtaj nazwƒô do tooltip√≥w
      feature._nm = name;
      layer.feature._nm = name;

      // mapowanie do podglƒÖdu poprawnej odpowiedzi
      if (key && !layerByKey.has(key)) layerByKey.set(key, layer);

      applyTooltip(layer, name);

      layer.on("mouseover", () => {
        if (state.locked) return;
        if (chkLearnMode.checked) return; // w trybie nauki nie podbijaj stylu
        layer.setStyle({ ...hoverStyle });
        layer.bringToFront();
      });

      layer.on("mouseout", () => {
        if (state.locked) return;
        if (chkLearnMode.checked) return;
        geoLayer.resetStyle(layer);
      });

      layer.on("click", () => {
        if (chkLearnMode.checked) return;
        if (state.locked) return;
        handleClick(key, name, layer);
      });
    }
  }).addTo(map);

  try {
    map.fitBounds(geoLayer.getBounds(), { padding: [12, 12] });
  } catch (_) {
    map.setView([52.1, 19.4], 6);
  }

  function startGame() {
    state.items = quizItems.slice();
    if (chkShuffleEachRun.checked) shuffle(state.items);

    state.idx = 0;
    state.score = 0;
    state.done = 0;
    state.locked = false;
    state.current = null;
    state.lastClicked = null;
    state.lastCorrect = null;

    setCounters();
    btnNext.disabled = true;
    btnRestart.disabled = false;

    resetAllStyles();
    nextQuestion();
  }

  startGame();

})();
</script>

</body>
</html>
